<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Personajes - Zombicide 2nd Edition</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c1810 0%, #4a2c1a 100%);
            color: #e8e8e8;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            color: #ff6b6b;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            margin-bottom: 30px;
        }

        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8787);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            margin: 0 10px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
        }

        .character-card {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid #ff6b6b;
            display: none;
        }

        .character-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ff6b6b;
        }

        .character-name {
            font-size: 1.8em;
            color: #ff6b6b;
            font-weight: bold;
        }

        .character-class {
            font-size: 1.2em;
            color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
        }

        .stat-label {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.1em;
            color: #e8e8e8;
        }

        .skills-container {
            margin-top: 25px;
        }

        .skills-title {
            font-size: 1.3em;
            color: #ff6b6b;
            margin-bottom: 15px;
            border-bottom: 1px solid #ff6b6b;
            padding-bottom: 5px;
        }

        .skills-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .skill-item {
            background: rgba(255, 107, 107, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #ff6b6b;
        }

        .skill-name {
            font-weight: bold;
            color: #ff6b6b;
        }

        .skill-description {
            color: #cccccc;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .api-success {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .api-error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        .api-loading {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid #FFC107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßü Generador de Personajes - Zombicide 2nd Edition üßü</h1>

        <div class="button-container">
            <button class="generate-btn" onclick="generateCharacter()">
                üé≤ Generar Nuevo Personaje
            </button>
            <button class="generate-btn" onclick="generateCharacterImage()" style="background: linear-gradient(45deg, #9C27B0, #BA68C8);">
                üé® Generar Imagen IA
            </button>
            <button class="generate-btn" onclick="saveCharacter()" style="background: linear-gradient(45deg, #4CAF50, #66BB6A);">
                üíæ Guardar Personaje
            </button>
            <button class="generate-btn" onclick="printCharacter()" style="background: linear-gradient(45deg, #2196F3, #42A5F5);">
                üñ®Ô∏è Imprimir Personaje
            </button>
        </div>

        <div class="api-config" style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #ffd700; margin-top: 0;">‚öôÔ∏è Configuraci√≥n API de IA</h3>
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <input type="password" id="apiKey" placeholder="Ingresa tu API Key de Replicate.com"
                       style="width: 300px; padding: 10px; border-radius: 5px; border: 1px solid #ff6b6b; background: rgba(0,0,0,0.3); color: white;">
                <button onclick="saveApiKey()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Guardar API Key
                </button>
            </div>
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                <label style="display: flex; align-items: center; color: #ffd700; cursor: pointer;">
                    <input type="checkbox" id="autoGenerateImage" checked onchange="saveAutoGeneratePreference()" style="margin-right: 8px; width: 18px; height: 18px;">
                    üé® Generar imagen autom√°ticamente
                </label>
                <span style="color: #ccc; font-size: 0.9em;">(A√±ade ~30-60 segundos por personaje)</span>
            </div>
            <p style="font-size: 0.9em; color: #ccc; margin-top: 10px;">
                üí° Obt√©n tu API key en <a href="https://replicate.com/account/api-tokens" target="_blank" style="color: #4CAF50;">Replicate.com</a>
            </p>
            <div id="apiStatus"></div>
        </div>

        <div id="characterCard" class="character-card">
            <div class="character-header">
                <div class="character-name" id="characterName"></div>
                <div class="character-class" id="characterClass"></div>
            </div>

            <div id="characterImageContainer" style="text-align: center; margin-bottom: 20px; display: none;">
                <div style="position: relative; display: inline-block;">
                    <img id="characterImage" src="" alt="Personaje Zombicide"
                         style="max-width: 300px; max-height: 300px; border-radius: 15px; border: 3px solid #ff6b6b; box-shadow: 0 5px 20px rgba(0,0,0,0.5);">
                    <div id="imageLoadingSpinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                        <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </div>
                <p style="margin-top: 10px; color: #ffd700; font-size: 0.9em;">üé® Imagen generada por IA</p>
            </div>

            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">üéØ Zona</div>
                    <div class="stat-value" id="rank"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">‚≠ê Experiencia</div>
                    <div class="stat-value" id="experience"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">‚ù§Ô∏è Vida</div>
                    <div class="stat-value" id="health"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">‚öîÔ∏è Arma Inicial</div>
                    <div class="stat-value" id="startingWeapon"></div>
                </div>
            </div>

            <div class="skills-container">
                <div class="skills-title">üõ°Ô∏è Habilidades</div>
                <div class="skills-list" id="skillsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Personajes oficiales de Zombicide 2nd Edition
        const characterNames = [
            "Jake la Bestia", "Silva la Cazadora", "Ned el Cirujano", "Amy la Atleta",
            "Wanda la Bruja", "Trent el Constructor", "Phil el Vigilante", "Angie la Azafata",
            "Doug el Capataz", "Claudia la Vengadora", "Rosa la Militar", "Kevin el N√≥mada",
            "Sam el Jardinero", "Brett el Chef", "Nick el Camarero", "Lily la Artista",
            "Martha la Abuela", "Manny el Mec√°nico", "Sandra la Enfermera", "Pablo el Boxeador"
        ];

        const characterArchetypes = [
            "Survivor", "Fighter", "Runner", "Searcher", "Healer", "Shooter", "Melee", "Looter"
        ];

        const zones = ["Zona Azul", "Zona Amarilla", "Zona Naranja", "Zona Roja"];

        const skills = {
            blue: [
                { name: "+1 Acci√≥n", description: "Ganas una acci√≥n adicional cada turno", xpRequired: 0 },
                { name: "+1 Da√±o", description: "Tus ataques infligen 1 punto de da√±o extra", xpRequired: 0 },
                { name: "+1 Movimiento", description: "Puedes moverte 1 casilla adicional", xpRequired: 0 },
                { name: "Portador de carga +1", description: "Puedes llevar un objeto adicional", xpRequired: 0 },
                { name: "Habilidoso", description: "Puedes usar dos habilidades diferentes en el mismo turno", xpRequired: 0 },
                { name: "Luchador", description: "Puedes luchar contra zombis en casillas adyacentes sin gastar acci√≥n", xpRequired: 0 }
            ],
            yellow: [
                { name: "Tiro r√°pido", description: "Con un arma de fuego, puedes hacer un ataque extra", xpRequired: 6 },
                { name: "Escolta", description: "Los supervivientes en tu zona no pueden ser atacados si est√°n contigo", xpRequired: 6 },
                { name: "Curandero", description: "Puedes curar 1 punto de da√±o a otro superviviente", xpRequired: 6 },
                { name: "Cuchillo de combate", description: "Tu cuchillo causa 2 da√±os en lugar de 1", xpRequired: 6 },
                { name: "Pistola de combate", description: "Tu pistola causa 2 da√±os en lugar de 1", xpRequired: 6 },
                { name: "Maestro cerrajero", description: "Abres puertas autom√°ticamente", xpRequired: 6 }
            ],
            orange: [
                { name: "Zombi Slayer", description: "Infliges +1 da√±o contra zombis", xpRequired: 13 },
                { name: "Barricadas maestras", description: "Tus barricadas tienen 3 puntos de vida", xpRequired: 13 },
                { name: "Tiro a la cabeza", description: "Si obtienes 6 en un ataque, infliges 1 punto de da√±o extra", xpRequired: 13 },
                { name: "Recargar y disparar", description: "Puedes recargar armas como acci√≥n gratuita", xpRequired: 13 },
                { name: "Experto en demolici√≥n", description: "Duplicas el da√±o contra objetivos destructibles", xpRequired: 13 },
                { name: "Inmunidad total", description: "Eres inmune a todos los efectos negativos", xpRequired: 13 }
            ],
            red: [
                { name: "L√≠der", description: "Los supervivientes en tu zona ganan +1 acci√≥n", xpRequired: 21 },
                { name: "Tirador experto", description: "Ignoras penalizadores por distancia", xpRequired: 21 },
                { name: "H√©roe local", description: "Todas tus estad√≠sticas aumentan en +1", xpRequired: 21 },
                { name: "Maestro superviviente", description: "Cuando mueras, regresas con tu experiencia completa", xpRequired: 21 },
                { name: "Explosivo", description: "Tus ataques afectan a todas las casillas adyacentes", xpRequired: 21 },
                { name: "Leyenda", description: "Ganas una acci√≥n adicional y +1 en todas las estad√≠sticas", xpRequired: 21 }
            ]
        };

        // Armas iniciales de cartas grises (Zombicide 2nd Edition)
        const startingWeapons = [
            { name: "Pistola", damage: 1, slots: 1, range: 1, type: "rango" },
            { name: "Cuchillo", damage: 1, slots: 1, range: "Cuerpo a cuerpo", type: "cuerpo a cuerpo" },
            { name: "Bate de B√©isbol", damage: 2, slots: 1, range: "Cuerpo a cuerpo", type: "cuerpo a cuerpo" },
            { name: "Maza", damage: 1, slots: 1, range: "Cuerpo a cuerpo", type: "cuerpo a cuerpo" },
            { name: "Llave Inglesa", damage: 1, slots: 1, range: "Cuerpo a cuerpo", type: "herramienta", special: "Abre puertas autom√°ticamente" }
        ];

        // Armas del juego completo (para referencias futuras)
        const allWeapons = {
            melee: [
                { name: "Bate de B√©isbol", damage: 2, slots: 1, range: "Cuerpo a cuerpo" },
                { name: "Hacha", damage: 2, slots: 1, range: "Cuerpo a cuerpo" },
                { name: "Maza", damage: 1, slots: 1, range: "Cuerpo a cuerpo" },
                { name: "Katana", damage: 3, slots: 1, range: "Cuerpo a cuerpo" },
                { name: "Machete", damage: 2, slots: 1, range: "Cuerpo a cuerpo" }
            ],
            ranged: [
                { name: "Pistola", damage: 1, slots: 1, range: 1 },
                { name: "Escopeta", damage: 2, slots: 2, range: 0 },
                { name: "Rifle de Caza", damage: 2, slots: 2, range: "‚àû" },
                { name: "Ametralladora", damage: 3, slots: 2, range: "‚àû" },
                { name: "Lanzallamas", damage: 1, slots: 2, range: 1, special: "√Årea de efecto" }
            ]
        };

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getRandomStartingWeapon() {
            return getRandomElement(startingWeapons);
        }

        function generateCharacter() {
            const name = getRandomElement(characterNames);
            const archetype = getRandomElement(characterArchetypes);
            const zoneIndex = Math.floor(Math.random() * zones.length);
            const zone = zones[zoneIndex];

            // Estad√≠sticas base seg√∫n Zombicide 2nd Edition
            let health = 3;
            let experience = 0;
            let allCharacterSkills = [];

            // Generar habilidades para todas las zonas (simulaci√≥n de carta de personaje completa)
            const blueSkill = { ...getRandomElement(skills.blue), zone: 'blue', zoneName: 'Azul', unlocked: true };
            const yellowSkill = { ...getRandomElement(skills.yellow), zone: 'yellow', zoneName: 'Amarillo', unlocked: false };
            const orangeSkill = { ...getRandomElement(skills.orange), zone: 'orange', zoneName: 'Naranja', unlocked: false };
            const redSkill = { ...getRandomElement(skills.red), zone: 'red', zoneName: 'Rojo', unlocked: false };

            switch(zoneIndex) {
                case 0: // Zona Azul
                    health = 3;
                    experience = 0;
                    blueSkill.unlocked = true;
                    allCharacterSkills = [blueSkill, yellowSkill, orangeSkill, redSkill];
                    break;
                case 1: // Zona Amarilla
                    health = 4;
                    experience = 6;
                    blueSkill.unlocked = true;
                    yellowSkill.unlocked = true;
                    allCharacterSkills = [blueSkill, yellowSkill, orangeSkill, redSkill];
                    break;
                case 2: // Zona Naranja
                    health = 4;
                    experience = 13;
                    blueSkill.unlocked = true;
                    yellowSkill.unlocked = true;
                    orangeSkill.unlocked = true;
                    allCharacterSkills = [blueSkill, yellowSkill, orangeSkill, redSkill];
                    break;
                case 3: // Zona Roja
                    health = 5;
                    experience = 21;
                    blueSkill.unlocked = true;
                    yellowSkill.unlocked = true;
                    orangeSkill.unlocked = true;
                    redSkill.unlocked = true;
                    allCharacterSkills = [blueSkill, yellowSkill, orangeSkill, redSkill];
                    break;
            }

            const startingWeapon = getRandomStartingWeapon();

            // Actualizar interfaz
            document.getElementById('characterName').textContent = name;
            document.getElementById('characterClass').textContent = `${archetype} - ${zone}`;
            document.getElementById('rank').textContent = zone;
            document.getElementById('experience').textContent = `${experience} XP`;
            document.getElementById('health').textContent = `${health} HP`;
            document.getElementById('startingWeapon').textContent = `${startingWeapon.name} (${startingWeapon.damage} da√±o, ${startingWeapon.slots} espacios, Alcance: ${startingWeapon.range}${startingWeapon.special ? ', ' + startingWeapon.special : ''})`;

            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';

            // Mostrar habilidades progresivas como en Zombicide
            allCharacterSkills.forEach(skill => {
                const skillElement = document.createElement('div');
                skillElement.className = 'skill-item';

                // Color y estilo seg√∫n zona
                let zoneColor = '#4169E1'; // Azul
                let bgColor = 'rgba(65, 105, 225, 0.1)'; // Azul transparente

                if (skill.zone === 'yellow') {
                    zoneColor = '#FFD700';
                    bgColor = 'rgba(255, 215, 0, 0.1)';
                } else if (skill.zone === 'orange') {
                    zoneColor = '#FF8C00';
                    bgColor = 'rgba(255, 140, 0, 0.1)';
                } else if (skill.zone === 'red') {
                    zoneColor = '#DC143C';
                    bgColor = 'rgba(220, 20, 60, 0.1)';
                }

                // Aplicar estilos
                skillElement.style.borderLeft = `4px solid ${zoneColor}`;
                skillElement.style.background = skill.unlocked ? bgColor : 'rgba(128, 128, 128, 0.05)';
                skillElement.style.opacity = skill.unlocked ? '1' : '0.6';

                skillElement.innerHTML = `
                    <div class="skill-name">
                        <span style="color: ${zoneColor};">‚óè</span> ${skill.name}
                        <span style="float: right; font-size: 0.8em; color: ${zoneColor}; font-weight: bold;">
                            ${skill.zoneName} (${skill.xpRequired} XP)
                        </span>
                    </div>
                    <div class="skill-description">${skill.description}</div>
                    <div style="margin-top: 8px; font-size: 0.8em; font-weight: bold; ${
                        skill.unlocked ? 'color: #4CAF50;' : 'color: #888;'
                    }">
                        ${skill.unlocked ? '‚úÖ DESBLOQUEADA' : 'üîí Requiere ' + skill.xpRequired + ' XP'}
                    </div>
                `;
                skillsList.appendChild(skillElement);
            });

            document.getElementById('characterCard').style.display = 'block';
        }

        // Funci√≥n para guardar personaje como JSON
        function saveCharacter() {
            const characterData = {
                name: document.getElementById('characterName').textContent,
                class: document.getElementById('characterClass').textContent,
                zone: document.getElementById('rank').textContent,
                experience: document.getElementById('experience').textContent,
                health: document.getElementById('health').textContent,
                startingWeapon: document.getElementById('startingWeapon').textContent,
                skills: Array.from(document.querySelectorAll('.skill-item')).map(skill => ({
                    name: skill.querySelector('.skill-name').textContent,
                    description: skill.querySelector('.skill-description').textContent
                })),
                generatedDate: new Date().toLocaleString('es-ES')
            };

            const dataStr = JSON.stringify(characterData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `${characterData.name.replace(/ /g, '_')}_Zombicide.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Funci√≥n para imprimir personaje
        function printCharacter() {
            const characterName = document.getElementById('characterName').textContent;
            const printStyles = `
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .character-header {
                        display: flex;
                        justify-content: space-between;
                        border-bottom: 2px solid #333;
                        padding-bottom: 15px;
                        margin-bottom: 20px;
                    }
                    .character-name { font-size: 1.8em; font-weight: bold; color: #333; }
                    .character-class { font-size: 1.2em; color: #666; background: #f0f0f0; padding: 5px 15px; border-radius: 20px; }
                    .stats-container {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 15px;
                        margin-bottom: 25px;
                    }
                    .stat-box {
                        background: #f9f9f9;
                        padding: 15px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                    }
                    .stat-label { font-weight: bold; color: #333; margin-bottom: 5px; }
                    .stat-value { font-size: 1.1em; color: #666; }
                    .skills-title { font-size: 1.3em; color: #333; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; }
                    .skill-item {
                        background: #f5f5f5;
                        padding: 12px;
                        margin-bottom: 10px;
                        border-left: 3px solid #666;
                        border-radius: 5px;
                    }
                    .skill-name { font-weight: bold; color: #333; }
                    .skill-description { color: #666; font-size: 0.9em; margin-top: 5px; }
                    .footer {
                        margin-top: 30px;
                        text-align: center;
                        font-size: 0.9em;
                        color: #666;
                        border-top: 1px solid #ddd;
                        padding-top: 20px;
                    }
                </style>
            `;

            const characterSkills = Array.from(document.querySelectorAll('.skill-item')).map(skill => `
                <div class="skill-item">
                    <div class="skill-name">${skill.querySelector('.skill-name').textContent}</div>
                    <div class="skill-description">${skill.querySelector('.skill-description').textContent}</div>
                </div>
            `).join('');

            const printHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Personaje Zombicide - ${characterName}</title>
                    ${printStyles}
                </head>
                <body>
                    <h1>üßü Personaje Zombicide 2nd Edition üßü</h1>
                    <div class="character-header">
                        <div class="character-name">${characterName}</div>
                        <div class="character-class">${document.getElementById('characterClass').textContent}</div>
                    </div>
                    <div class="stats-container">
                        <div class="stat-box">
                            <div class="stat-label">üéØ Zona</div>
                            <div class="stat-value">${document.getElementById('rank').textContent}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">‚≠ê Experiencia</div>
                            <div class="stat-value">${document.getElementById('experience').textContent}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">‚ù§Ô∏è Vida</div>
                            <div class="stat-value">${document.getElementById('health').textContent}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">‚öîÔ∏è Arma Inicial</div>
                            <div class="stat-value">${document.getElementById('startingWeapon').textContent}</div>
                        </div>
                    </div>
                    <div class="skills-container">
                        <div class="skills-title">üõ°Ô∏è Habilidades</div>
                        ${characterSkills}
                    </div>
                    <div class="footer">
                        <p>Generado el: ${new Date().toLocaleString('es-ES')}</p>
                        <p>Zombicide 2nd Edition - Generador de Personajes</p>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHtml);
            printWindow.document.close();
            printWindow.print();
        }

        // Funciones para la API de generaci√≥n de im√°genes
        let currentCharacterData = {};

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            if (apiKey) {
                localStorage.setItem('replicateApiKey', apiKey);
                showApiStatus('‚úÖ API Key guardada correctamente', 'success');
                document.getElementById('apiKey').value = '';
            } else {
                showApiStatus('‚ùå Por favor ingresa una API Key v√°lida', 'error');
            }
        }

        function setApiKeyDirectly(apiKey) {
            localStorage.setItem('replicateApiKey', apiKey);
            showApiStatus('‚úÖ API Key integrada correctamente', 'success');
        }

        function saveAutoGeneratePreference() {
            const checkbox = document.getElementById('autoGenerateImage');
            localStorage.setItem('autoGenerateImage', checkbox.checked);
        }

        function getAutoGeneratePreference() {
            const saved = localStorage.getItem('autoGenerateImage');
            return saved !== null ? saved === 'true' : true; // Por defecto true
        }

        function getApiKey() {
            return localStorage.getItem('replicateApiKey');
        }

        function showApiStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.className = `api-status api-${type}`;
            statusDiv.textContent = message;

            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        function generateCharacterImage() {
            const apiKey = getApiKey();

            if (!apiKey) {
                showApiStatus('‚ùå Por favor configura tu API Key primero', 'error');
                return;
            }

            if (!currentCharacterData.name) {
                showApiStatus('‚ùå Por favor genera un personaje primero', 'error');
                return;
            }

            const imageContainer = document.getElementById('characterImageContainer');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');
            const characterImage = document.getElementById('characterImage');

            // Mostrar loading
            imageContainer.style.display = 'block';
            loadingSpinner.style.display = 'block';
            characterImage.style.display = 'none';
            showApiStatus('üé® Generando imagen... esto puede tardar 30-60 segundos', 'loading');

            // Crear prompt detallado para el personaje
            const prompt = createDetailedPrompt(currentCharacterData);

            // Llamar a la API de Replicate
            callReplicateAPI(apiKey, prompt);
        }

        function createDetailedPrompt(character) {
            const weaponName = character.startingWeapon.split('(')[0].trim();
            const gender = determineGender(character.name);
            const archetype = character.archetype.toLowerCase();

            return `${character.name}, ${archetype} survivor, realistic post-apocalyptic character portrait,
            gritty detailed artwork, zombie apocalypse survivor, weathered face, determined expression,
            wearing practical scavenged clothes and makeshift armor, tactical gear, holding ${weaponName},
            dark post-apocalyptic background, realistic lighting, detailed textures, high contrast,
            game character concept art, realistic proportions, detailed facial features,
            post-apocalyptic aesthetic, survivor look, cinematic game art, detailed illustration,
            realistic but stylized, game-ready character design, end of the world atmosphere`;
        }

        function determineGender(name) {
            const femaleNames = ['Silva', 'Amy', 'Wanda', 'Angie', 'Claudia', 'Rosa', 'Lily', 'Martha', 'Sandra'];
            const nameParts = name.split(' ')[0];
            return femaleNames.includes(nameParts) ? 'female' : 'male';
        }

        async function callReplicateAPI(apiKey, prompt) {
            try {
                const response = await fetch('https://api.replicate.com/v1/predictions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        version: "ac732df83cea7fff18b8472768c88ad041fa750ff7682a21affe81863cbe77e4", // Stable Diffusion XL
                        input: {
                            prompt: prompt,
                            width: 512,
                            height: 768,
                            num_outputs: 1,
                            num_inference_steps: 25,
                            guidance_scale: 8.0,
                            negative_prompt: "cartoon, anime, manga, disney, pixar, 3d render, video game, cgi, overly smooth, plastic, toy-like, childish, colorful, bright, cheerful, clean, perfect, pristine, cartoonish, animated, game graphics, polygonal, low poly, toy, figurine, chibi, kawaii, cute"
                        }
                    })
                });

                const prediction = await response.json();

                if (prediction.error) {
                    throw new Error(prediction.error);
                }

                // Poll for completion
                pollForCompletion(apiKey, prediction.id);

            } catch (error) {
                console.error('Error calling Replicate API:', error);
                showApiStatus(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('imageLoadingSpinner').style.display = 'none';
            }
        }

        async function pollForCompletion(apiKey, predictionId) {
            const maxAttempts = 60; // 5 minutes max
            let attempts = 0;

            const poll = async () => {
                attempts++;

                try {
                    const response = await fetch(`https://api.replicate.com/v1/predictions/${predictionId}`, {
                        headers: {
                            'Authorization': `Token ${apiKey}`,
                        }
                    });

                    const prediction = await response.json();

                    if (prediction.status === 'succeeded') {
                        displayGeneratedImage(prediction.output[0]);
                        showApiStatus('‚úÖ ¬°Imagen generada con √©xito!', 'success');
                    } else if (prediction.status === 'failed') {
                        throw new Error('La generaci√≥n de la imagen fall√≥');
                    } else if (prediction.status === 'processing' && attempts < maxAttempts) {
                        // Still processing, continue polling
                        setTimeout(poll, 2000); // Check every 2 seconds
                    } else {
                        throw new Error('Tiempo de espera agotado');
                    }
                } catch (error) {
                    console.error('Error polling:', error);
                    showApiStatus(`‚ùå Error: ${error.message}`, 'error');
                    document.getElementById('imageLoadingSpinner').style.display = 'none';
                }
            };

            poll();
        }

        function displayGeneratedImage(imageUrl) {
            const characterImage = document.getElementById('characterImage');
            const loadingSpinner = document.getElementById('imageLoadingSpinner');

            characterImage.src = imageUrl;
            characterImage.onload = function() {
                loadingSpinner.style.display = 'none';
                characterImage.style.display = 'block';
            };

            characterImage.onerror = function() {
                loadingSpinner.style.display = 'none';
                showApiStatus('‚ùå Error al cargar la imagen generada', 'error');
            };
        }

        // Modificar generateCharacter para guardar los datos y generar imagen autom√°ticamente
        const originalGenerateCharacter = generateCharacter;
        generateCharacter = function() {
            originalGenerateCharacter();

            // Guardar datos del personaje actual
            currentCharacterData = {
                name: document.getElementById('characterName').textContent,
                archetype: document.getElementById('characterClass').textContent.split(' - ')[0],
                zone: document.getElementById('characterClass').textContent.split(' - ')[1],
                startingWeapon: document.getElementById('startingWeapon').textContent
            };

            // Ocultar imagen anterior al generar nuevo personaje
            document.getElementById('characterImageContainer').style.display = 'none';

            // Generar imagen autom√°ticamente si est√° activado y hay API key
            const autoGenerate = getAutoGeneratePreference();
            const apiKey = getApiKey();

            if (autoGenerate && apiKey) {
                // Peque√±o delay para asegurar que el personaje se muestre primero
                setTimeout(() => {
                    generateCharacterImage();
                }, 500);
            } else if (autoGenerate && !apiKey) {
                showApiStatus('üé® Generaci√≥n autom√°tica activada pero necesita API Key', 'error');
            }
        };

        // Generar personaje al cargar la p√°gina
        window.onload = function() {
            // Integrar API Key directamente
            const apiKey = 'r8_0IuxFzqWiZM7g0txeBIAt1UfU0Q3nqS2WrqqJ';
            setApiKeyDirectly(apiKey);

            // Cargar preferencias guardadas
            const autoGeneratePref = getAutoGeneratePreference();
            document.getElementById('autoGenerateImage').checked = autoGeneratePref;

            // Mostrar estado de la API key
            showApiStatus('‚úÖ API Key integrada autom√°ticamente', 'success');
            if (autoGeneratePref) {
                showApiStatus('üé® Generaci√≥n autom√°tica de im√°genes activada', 'success');
            }

            // Generar primer personaje
            generateCharacter();
        };
    </script>
</body>
</html>